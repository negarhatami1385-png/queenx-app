<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>QueenX â€” Mobile (Theme & Animations)</title>

<link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="https://kit.fontawesome.com/a2e0b5a3c7.js" crossorigin="anonymous"></script>

<style>
/* ========== THEME VARIABLES ========== */
/* default = dark */
:root {
  --bg: #06060a;
  --card: linear-gradient(180deg,#0f1220,#0b0d16);
  --muted: #9aa0a6;
  --text: #f6f6f8;
  --accent: #ff7eb3;
  --accent2: #ff4d94;
  --success: #00b894;
  --danger: #ff6b6b;
  --glass: rgba(255,255,255,0.04);
  --radius: 16px;
  --shadow: 0 12px 30px rgba(0,0,0,0.6);
  --card-elev: rgba(255,255,255,0.02);
  --nav-bg: linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.55));
}

/* light theme overrides */
:root[data-theme="light"]{
  --bg: linear-gradient(180deg,#f6f7fb,#eef2ff);
  --card: linear-gradient(180deg,#ffffff,#fbfbff);
  --muted: #566170;
  --text: #0b1220;
  --accent: #ff5ea8;
  --accent2: #ff3b7a;
  --glass: rgba(11,18,32,0.03);
  --shadow: 0 8px 20px rgba(16,24,40,0.08);
  --card-elev: rgba(14,18,34,0.02);
  --nav-bg: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.95));
}

/* ========== Base ========== */
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;font-family:'Vazirmatn',sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
body{display:flex;flex-direction:column}

/* ========== App shell (mobile-first) ========== */
.app-shell{width:100%;max-width:480px;margin:0 auto;display:flex;flex-direction:column;height:100vh;position:relative}
.header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:transparent}
.header .left{display:flex;gap:12px;align-items:center}
.avatar{width:48px;height:48px;border-radius:50%;border:2px solid var(--accent);object-fit:cover;box-shadow:0 6px 18px rgba(0,0,0,0.3)}
.title{font-weight:800;font-size:1.05rem}
.subtitle{font-size:0.85rem;color:var(--muted)}

/* content scroll area */
.main{flex:1;overflow-y:auto;padding:12px 14px;padding-bottom:120px;-webkit-overflow-scrolling:touch}

/* card with entrance animation */
.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:12px;margin-bottom:12px;border:1px solid var(--card-elev);
  box-shadow:var(--shadow);
  transform:translateY(8px);opacity:0;animation:cardIn .45s cubic-bezier(.2,.9,.3,1) forwards;
  transition:transform .25s ease, box-shadow .25s ease;
}
@keyframes cardIn { to{ transform:translateY(0); opacity:1 } }

/* hover / active elevation */
.card:active{ transform:translateY(2px); box-shadow:0 6px 18px rgba(0,0,0,0.4) }

/* small helpers */
.section-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.small-muted{font-size:0.85rem;color:var(--muted)}
.center{display:flex;align-items:center;justify-content:center}
.hidden{display:none}

/* ========== Dashboard ========== */
.dash-stats{display:flex;gap:10px;justify-content:space-between}
.stat{flex:1;background:transparent;padding:10px;border-radius:10px;text-align:center;backdrop-filter:blur(6px)}
.stat strong{display:block;font-size:1.2rem}

/* progress bar */
.progress-wrap{height:10px;background:linear-gradient(90deg, rgba(0,0,0,0.05), rgba(0,0,0,0.02));border-radius:999px;overflow:hidden;margin-top:8px}
.progress-bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .9s cubic-bezier(.2,.9,.3,1)}

/* motivation */
.motiv-msg{font-weight:800;font-size:1rem;margin-bottom:6px;opacity:0;transform:translateY(6px);animation:motivIn .6s ease forwards}
@keyframes motivIn{ to{opacity:1;transform:none} }

/* rotating subtle background pulse */
.motiv-card{position:relative;overflow:hidden}
.motiv-card::after{
  content:"";position:absolute;right:-40%;top:-40%;width:180%;height:180%;background:radial-gradient(circle at 10% 20%, rgba(255,126,179,0.06), transparent 10%), radial-gradient(circle at 80% 80%, rgba(123,97,255,0.05), transparent 12%);
  transform:rotate(0deg);filter:blur(16px);pointer-events:none;animation:slowSpin 18s linear infinite;
}
@keyframes slowSpin{ from{transform:rotate(0deg)} to{transform:rotate(360deg)} }

/* motiv pulse on update */
.motiv-pulse{animation:pop 0.45s cubic-bezier(.2,.9,.3,1)}
@keyframes pop{0%{transform:scale(.98);opacity:.8}50%{transform:scale(1.02);opacity:1}100%{transform:none}}

/* ========== Water ========== */
.water-row{display:flex;align-items:center;justify-content:space-between;gap:10px}
.water-grid{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.water-cup{font-size:1.5rem;padding:8px;border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:transform .22s ease, color .2s ease, opacity .2s ease}
.water-cup.full{color:#36a2ff;transform:scale(1.06);box-shadow:0 8px 20px rgba(54,162,255,0.12)}
.water-cup:active{transform:scale(.98)}
/* subtle periodic pulse for goal reached */
.water-goal-achieved{animation:waterGoal 1.4s ease 1}
@keyframes waterGoal{0%{transform:scale(1);box-shadow:0 8px 20px rgba(54,162,255,0)}50%{transform:scale(1.06);box-shadow:0 18px 40px rgba(54,162,255,0.14)}100%{transform:none;box-shadow:0 8px 20px rgba(54,162,255,0.12)}}

/* ========== Todos ========== */
.todo-item{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
.todo-title{flex:1}
.tag{background:rgba(255,255,255,0.03);padding:6px;border-radius:8px;font-size:0.8rem;color:var(--muted)}

/* ========== FAB & bottom nav ========== */
.bottom-nav{
  position:fixed;left:0;right:0;bottom:0;height:78px;
  background:var(--nav-bg);backdrop-filter:blur(8px);
  display:flex;justify-content:space-around;align-items:center;padding:12px 14px;border-top:1px solid var(--glass);z-index:40;max-width:480px;margin:0 auto;border-radius:12px 12px 0 0;
  transition:transform .25s ease, background .25s ease;
}
.nav-btn{display:flex;flex-direction:column;align-items:center;color:var(--muted);font-size:12px;text-decoration:none;transition:transform .25s ease,color .25s ease}
.nav-btn.active{color:var(--accent);transform:translateY(-6px)}
.fab{width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;color:#111;font-weight:900;box-shadow:0 12px 32px rgba(0,0,0,0.35);transform:translateY(-28px);transition:transform .18s cubic-bezier(.2,.9,.3,1)}
.fab:active{transform:translateY(-24px) scale(.98)}

/* ripple for button press (mobile) */
.btn-press{position:relative;overflow:hidden}
.btn-press::after{content:"";position:absolute;left:50%;top:50%;width:0;height:0;background:rgba(255,255,255,0.06);border-radius:50%;transform:translate(-50%,-50%);transition:width .3s ease,height .3s ease,opacity .3s ease}
.btn-press:active::after{width:220px;height:220px;opacity:0}

/* ========== Small transitions ========== */
.input{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text);transition:box-shadow .18s ease, border-color .18s ease}
.input:focus{outline:none;box-shadow:0 6px 24px rgba(0,0,0,0.18);border-color:var(--accent)}
.select{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text);min-width:90px}
.btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#111;padding:10px;border-radius:10px;border:none;font-weight:800}
.nav-btn, .btn-ghost{background:transparent;border:none;color:var(--muted)}

@media(min-width:520px){
  .app-shell{border-radius:12px;overflow:hidden}
  .main{padding:18px}
}
</style>
</head>
<body>

<div class="app-shell" id="appShell">
  <header class="header">
    <div class="left">
      <img id="profileAvatar" class="avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Queen" alt="avatar">
      <div>
        <div class="title" id="profileName">Ù…Ù„Ú©Ù‡ Ù…Ù†</div>
        <div class="subtitle" id="profileRank">Novice Dreamer</div>
      </div>
    </div>
    <div>
      <button id="openSettingsBtn" class="nav-btn" style="font-size:18px" onclick="openSettings()">âš™ï¸</button>
    </div>
  </header>

  <main class="main" id="mainContent">

    <section id="view-dashboard">
      <div class="card">
        <div class="section-title"><strong>Ø¹Ù…Ù„Ú©Ø±Ø¯ Ú©Ù„ÛŒ</strong><span class="small-muted" id="overviewDate"></span></div>
        <div class="dash-stats">
          <div class="stat"><div class="small-muted">Ø³Ø·Ø­</div><strong id="dashLevel">1</strong></div>
          <div class="stat"><div class="small-muted">XP</div><strong id="dashXP">0 / 100</strong></div>
        </div>

        <div style="margin-top:12px">
          <div class="small-muted">Ù¾ÛŒØ´Ø±ÙØª Ú©Ù„</div>
          <div class="progress-wrap"><div id="dashProgress" class="progress-bar"></div></div>
        </div>

        <div style="margin-top:12px">
          <canvas id="dashChart" height="80"></canvas>
        </div>
      </div>

      <div class="card motiv-card" id="motivCard">
        <div class="section-title"><strong>Ù¾ÛŒØ§Ù… Ø§Ù†Ú¯ÛŒØ²Ø´ÛŒ</strong><button class="nav-btn" onclick="manageMotivations()">ÙˆÛŒØ±Ø§ÛŒØ´</button></div>
        <div class="motiv-msg" id="motivText">ØªÙˆ Ø§Ù…Ø±ÙˆØ² Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø±Ø®Ø´Ø´ âœ¨</div>
        <div class="small-muted" style="margin-top:8px">Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ù‡Ø± Ú†Ù†Ø¯ Ø«Ø§Ù†ÛŒÙ‡ ØªØºÛŒÛŒØ± Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯. Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯Øª Ø±Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒ.</div>
      </div>

      <div class="card">
        <div class="section-title"><strong>Ø¢Ø¨</strong><span class="small-muted">Ù‡Ø¯Ù Ø±ÙˆØ²Ø§Ù†Ù‡: <span id="waterGoal">8</span></span></div>
        <div class="water-row">
          <div class="water-grid" id="miniWater"></div>
          <div style="min-width:110px;text-align:center">
            <div class="small-muted">Ø§Ù…Ø±ÙˆØ²</div>
            <div style="font-weight:800" id="miniWaterCount">0 / 8</div>
            <div style="margin-top:8px;display:flex;gap:6px;justify-content:center">
              <button class="btn-primary btn-press" style="padding:8px 10px;border-radius:10px" onclick="Water.add()">ï¼‹</button>
              <button class="nav-btn" onclick="Water.remove()">âˆ’</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="view-todos" class="hidden">
      <div class="card">
        <div class="section-title"><strong>ØªØ³Ú©â€ŒÙ‡Ø§ (Notion-like)</strong><div class="small-muted" id="todosCount">0 Ù…ÙˆØ±Ø¯</div></div>

        <div style="display:flex;gap:8px;margin-bottom:8px">
          <input id="todoTitle" class="input" placeholder="Ø¹Ù†ÙˆØ§Ù† Ú©Ø§Ø±..." />
          <button class="btn-primary" onclick="Todos.addFromUI()">Ø§ÙØ²ÙˆØ¯Ù†</button>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px;margin-bottom:10px">
          <select id="todoRole" class="select">
            <option value="Ø¹Ù…ÙˆÙ…ÛŒ">Ø¹Ù…ÙˆÙ…ÛŒ</option><option value="Ú©Ø§Ø±ÛŒ">Ú©Ø§Ø±ÛŒ</option><option value="Ø´Ø®ØµÛŒ">Ø´Ø®ØµÛŒ</option><option value="Ø³Ù„Ø§Ù…Øª">Ø³Ù„Ø§Ù…Øª</option>
          </select>
          <input id="todoDate" type="date" class="select" />
          <input id="todoTime" type="time" class="select" />
          <select id="todoRepeat" class="select"><option value="once">ÛŒÚ©â€ŒØ¨Ø§Ø±</option><option value="daily">Ø±ÙˆØ²Ø§Ù†Ù‡</option><option value="weekly">Ù‡ÙØªÚ¯ÛŒ</option><option value="monthly">Ù…Ø§Ù‡Ø§Ù†Ù‡</option></select>
        </div>

        <div style="display:flex;gap:8px;margin-bottom:8px">
          <button class="nav-btn" onclick="Todos.filter='all'; Todos.render();">Ù‡Ù…Ù‡</button>
          <button class="nav-btn" onclick="Todos.filter='due'; Todos.render();">Ø§Ù…Ø±ÙˆØ²</button>
          <button class="nav-btn" onclick="Todos.filter='incomplete'; Todos.render();">Ù†Ø§ØªÙ…Ø§Ù…</button>
        </div>

        <div class="todo-list" id="todoList"></div>
      </div>
    </section>

    <section id="view-journal" class="hidden">
      <div class="card">
        <div class="section-title"><strong>Ø¯ÙØªØ±Ú†Ù‡</strong><span class="small-muted">Ø«Ø¨Øª Ø§Ø­Ø³Ø§Ø³ Ùˆ Ø±ÙˆØ²Ù†Ú¯Ø§Ø±</span></div>

        <input id="journalTitle" class="input" placeholder="Ø¹Ù†ÙˆØ§Ù†..." />
        <textarea id="journalText" class="input" placeholder="Ù…ØªÙ† Ø®Ø§Ø·Ø±Ù‡..." style="margin-top:8px"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <select id="journalMood" class="select" style="flex:0 0 100px"><option>ğŸ˜</option><option>ğŸ˜Š</option><option>ğŸ˜Œ</option><option>ğŸ¤”</option><option>ğŸ˜”</option><option>ğŸ˜¤</option></select>
          <input id="journalTrigger" class="input" placeholder="Ú†Ù‡ Ú†ÛŒØ²ÛŒ Ø¨Ø§Ø¹Ø« Ø´Ø¯ØŸ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" />
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn-primary" style="flex:1" onclick="Journal.addFromUI()">Ø«Ø¨Øª</button>
          <button class="nav-btn" onclick="Journal.export()">Ø§Ú©Ø³Ù¾ÙˆØ±Øª</button>
        </div>

        <div style="margin-top:10px" class="small-muted">Ø®Ø§Ø·Ø±Ø§Øª Ø§Ø®ÛŒØ±</div>
        <div class="journal-list" id="journalList"></div>
      </div>
    </section>

    <section id="view-wallet" class="hidden">
      <div class="card">
        <div class="section-title"><strong>Ú©ÛŒÙ Ù¾ÙˆÙ„</strong><span class="small-muted">Ú©Ù†ØªØ±Ù„ ØªØ±Ø§Ú©Ù†Ø´</span></div>

        <div style="display:flex;gap:8px">
          <input id="txAmount" class="input" placeholder="Ù…Ø¨Ù„Øº" type="number" />
          <input id="txDesc" class="input" placeholder="ØªÙˆØ¶ÛŒØ­" />
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn-primary" style="flex:1" onclick="Wallet.addFromUI('income')">Ø¯Ø±Ø¢Ù…Ø¯</button>
          <button class="nav-btn" onclick="Wallet.addFromUI('expense')">Ù‡Ø²ÛŒÙ†Ù‡</button>
        </div>

        <div style="margin-top:10px" class="small-muted">Ù…ÙˆØ¬ÙˆØ¯ÛŒ</div>
        <div style="font-weight:800;font-size:1.4rem" id="walletBalance">0</div>

        <div style="margin-top:10px" class="small-muted">ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ±</div>
        <div class="tx-list" id="txList"></div>
      </div>
    </section>

    <section id="view-analytics" class="hidden">
      <div class="card">
        <div class="section-title"><strong>Ø¢Ù†Ø§Ù„ÛŒØ²</strong><span class="small-muted">XP Ùˆ Ø¢Ø¨ Ù‡ÙØªÙ‡</span></div>
        <canvas id="xpChart" height="120"></canvas>
        <div style="height:8px"></div>
        <canvas id="waterChart" height="120"></canvas>
      </div>
    </section>

  </main>

  <nav class="bottom-nav" role="navigation" aria-label="Ø§ØµÙ„ÛŒ">
    <div class="nav-btn active" id="nav-dashboard" onclick="switchView('dashboard', this)"><i class="fas fa-home" style="font-size:18px"></i><span>Ø®Ø§Ù†Ù‡</span></div>
    <div class="nav-btn" id="nav-todos" onclick="switchView('todos', this)"><i class="fas fa-list-check" style="font-size:18px"></i><span>ØªØ³Ú©â€ŒÙ‡Ø§</span></div>
    <div class="fab" onclick="switchView('water')"><i class="fas fa-tint"></i></div>
    <div class="nav-btn" id="nav-journal" onclick="switchView('journal', this)"><i class="fas fa-book" style="font-size:18px"></i><span>Ø¯ÙØªØ±</span></div>
    <div class="nav-btn" id="nav-wallet" onclick="switchView('wallet', this)"><i class="fas fa-wallet" style="font-size:18px"></i><span>Ú©ÛŒÙ Ù¾ÙˆÙ„</span></div>
  </nav>
</div>

<div id="toast" style="position:fixed;left:50%;transform:translateX(-50%);bottom:96px;background:rgba(0,0,0,0.65);color:white;padding:10px 14px;border-radius:10px;display:none;z-index:60"></div>

<script>
/* ---------------------------
   State & storage (same key)
   --------------------------- */
const KEY = 'queenx_mobile_v1';
const defaultState = {
  profile:{name:'Ù…Ù„Ú©Ù‡ Ù…Ù†', avatar:'https://api.dicebear.com/7.x/avataaars/svg?seed=Queen'},
  xp:{level:1,xp:0},
  motivations:["ØªÙˆ Ø§Ù…Ø±ÙˆØ² Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø±Ø®Ø´Ø´ âœ¨","Ù‚Ø¯Ù…â€ŒÙ‡Ø§ÛŒ Ú©ÙˆÚ†Ú©ØŒ Ù…Ø³ÛŒØ±Ù‡Ø§ÛŒ Ø¨Ø²Ø±Ú¯ Ù…ÛŒâ€ŒØ³Ø§Ø²Ù†Ø¯.","Ù†ÙØ³ Ø¹Ù…ÛŒÙ‚ Ùˆ Ø´Ø±ÙˆØ¹ Ø¯ÙˆØ¨Ø§Ø±Ù‡."],
  todos:[],
  water:{goal:8,history:{}},
  journal:[],
  wallet:{balance:0,transactions:[],debts:[],goals:[]},
  stats:{xpWeek:[0,0,0,0,0,0,0],waterWeek:[0,0,0,0,0,0,0]},
  settings:{notify:true,theme: (window.matchMedia && window.matchMedia('(prefers-color-scheme:light)').matches) ? 'light' : 'dark' }
};
let state = JSON.parse(localStorage.getItem(KEY) || 'null') || defaultState;

/* ------------- Helpers ------------- */
function save(){ localStorage.setItem(KEY, JSON.stringify(state)); renderAll(); }
function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,6); }
function todayStr(){ return new Date().toLocaleDateString('fa-IR'); }
function showToast(txt, t=2600){ const el=document.getElementById('toast'); el.innerText=txt; el.style.display='block'; clearTimeout(el._h); el._h=setTimeout(()=>el.style.display='none',t); }

// Ø¨Ø®Ø´ Ø§Ù…Ù†ÛŒØªÛŒ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø´Ø¯ ØªØ§ Ù¾ÛŒØ§Ù… Ø¢Ø²Ø§Ø±Ø¯Ù‡Ù†Ø¯Ù‡ Ø­Ø°Ù Ø´ÙˆØ¯
function requestNotif(){ 
  // ØºÛŒØ±ÙØ¹Ø§Ù„ Ø³Ø§Ø²ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ø±ÙˆØ±Ú¯Ø±
  console.log("Browser notification request skipped for UX improvement.");
}

function notify(title, body){ 
  // ÙÙ‚Ø· Ø§Ø² Ø³ÛŒØ³ØªÙ… Ù¾ÛŒØ§Ù… Ø¯Ø§Ø®Ù„ÛŒ Ø®ÙˆØ¯Øª Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ù‡
  showToast(body); 
}

function confettiSafe(){ try{ confetti(); }catch(e){} }

/* ========== THEME ========== */
function applyTheme(theme){
  document.documentElement.setAttribute('data-theme', theme || state.settings.theme);
  state.settings.theme = theme || state.settings.theme;
  localStorage.setItem(KEY, JSON.stringify(state));
  // small visual feedback
  document.getElementById('profileAvatar').style.borderColor = state.settings.theme === 'light' ? 'var(--accent2)' : 'var(--accent)';
}
applyTheme(state.settings.theme);

/* ========== Motivations ========== */
let motivIndex = 0;
function rotateMotiv(){ if(!state.motivations.length) return; motivIndex=(motivIndex+1)%state.motivations.length; const el=document.getElementById('motivText'); el.classList.remove('motiv-pulse'); void el.offsetWidth; el.innerText = state.motivations[motivIndex]; el.classList.add('motiv-pulse'); }
function manageMotivations(){
  Swal.fire({
    title:'Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø§Ù†Ú¯ÛŒØ²Ø´ÛŒ',
    html:`<textarea id="motArea" class="swal2-textarea" style="direction:rtl">${state.motivations.join('\\n')}</textarea>
          <div style="display:flex;gap:8px;margin-top:6px"><button id="saveBtn" class="swal2-confirm swal2-styled">Ø°Ø®ÛŒØ±Ù‡</button></div>`,
    didOpen: ()=>{
      document.getElementById('saveBtn').onclick = ()=>{
        const v = document.getElementById('motArea').value;
        state.motivations = v.split('\\n').map(s=>s.trim()).filter(Boolean);
        save();
        Swal.close();
        showToast('Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
      };
    }
  });
}

/* ========== DASHBOARD ========== */
let dashChart = null;
function renderDashboard(){
  document.getElementById('dashLevel').innerText = state.xp.level;
  document.getElementById('dashXP').innerText = `${state.xp.xp} / ${state.xp.level*100}`;
  document.getElementById('overviewDate').innerText = todayStr();
  // progress width
  const pct = Math.min(100, Math.round((state.xp.xp / (state.xp.level*100)) * 100));
  const prog = document.getElementById('dashProgress'); if(prog) prog.style.width = pct + '%';
  // chart
  try{
    const ctx = document.getElementById('dashChart').getContext('2d');
    if(dashChart) dashChart.destroy();
    dashChart = new Chart(ctx, { type:'bar', data:{ labels:['Ø´','ÛŒ','Ø¯','Ø³','Ú†','Ù¾','Ø¬'], datasets:[{ data: state.stats.xpWeek, backgroundColor: state.settings.theme==='light' ? '#ff9fcf' : '#ff7eb3' }] }, options:{ plugins:{ legend:{display:false} }, scales:{ y:{display:false}, x:{grid:{display:false}} } } });
  }catch(e){ console.warn('dash chart err', e) }
}

/* ========== TODOS ========== */
const Todos = {
  filter:'all',
  addFromUI(){
    const title = document.getElementById('todoTitle').value.trim();
    if(!title) return showToast('Ø¹Ù†ÙˆØ§Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†');
    const role = document.getElementById('todoRole').value;
    const date = document.getElementById('todoDate').value || new Date().toISOString().slice(0,10);
    const time = document.getElementById('todoTime').value || '';
    const repeat = document.getElementById('todoRepeat').value || 'once';
    this.add({title,role,date,time,repeat});
    document.getElementById('todoTitle').value='';
  },
  add({title,role,date,time,repeat}){
    const it = { id:uid(), title, role, date, time, repeat, done:false };
    state.todos.push(it); save(); notify('ØªØ³Ú© Ø§ÙØ²ÙˆØ¯Ù‡ Ø´Ø¯', title);
  },
  toggle(id){
    const it = state.todos.find(x=>x.id===id); if(!it) return;
    it.done = !it.done;
    if(it.done){
      addXP(20);
      notify('Ø¢ÙØ±ÛŒÙ†', `ØªØ³Ú© "${it.title}" Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯`);
      // recurrence
      if(it.repeat && it.repeat!=='once'){
        const cur = new Date(it.date);
        let nx = new Date(cur);
        if(it.repeat==='daily') nx.setDate(cur.getDate()+1);
        if(it.repeat==='weekly') nx.setDate(cur.getDate()+7);
        if(it.repeat==='monthly') nx.setMonth(cur.getMonth()+1);
        it.date = nx.toISOString().slice(0,10);
        it.done = false;
      }
    }
    save();
  },
  delete(id){ state.todos = state.todos.filter(t=>t.id!==id); save(); },
  render(){
    const list = document.getElementById('todoList'); list.innerHTML='';
    let items = [...state.todos];
    if(this.filter==='due'){ const td = new Date().toISOString().slice(0,10); items = items.filter(i=>i.date===td); }
    else if(this.filter==='incomplete') items = items.filter(i=>!i.done);
    items.sort((a,b)=> (a.date||'').localeCompare(b.date||''));
    items.forEach(it=>{
      const el = document.createElement('div'); el.className='todo-item';
      el.innerHTML = `<input type="checkbox" ${it.done?'checked':''} onchange="Todos.toggle('${it.id}')">
        <div class="todo-title"><div style="font-weight:700">${it.title}</div><div class="small-muted">${it.date} ${it.time} â€¢ ${it.role}</div></div>
        <div style="display:flex;gap:6px;align-items:center"><div class="tag">${it.repeat}</div><button class="nav-btn" onclick="Todos.delete('${it.id}')"><i class="fas fa-trash"></i></button></div>`;
      list.appendChild(el);
    });
    document.getElementById('todosCount').innerText = `${state.todos.length} Ù…ÙˆØ±Ø¯`;
  }
};

/* ========== WATER ========== */
function addToWeek(key,date,add){
  const idx = (date.getDay()+6)%7;
  state.stats[key] = state.stats[key] || [0,0,0,0,0,0,0];
  state.stats[key][idx] = (state.stats[key][idx]||0) + add;
}
const Water = {
  add(){
    const d = todayStr();
    state.water.history[d] = (state.water.history[d] || 0) + 1;
    addToWeek('waterWeek', new Date(), 1);
    const cur = state.water.history[d];
    if(cur >= state.water.goal){ addXP(50); notify('Ù‡ÛŒØ¯Ø±Ø§ØªØ§Ø³ÛŒÙˆÙ† Ú©Ø§Ù…Ù„','ØªØ¨Ø±ÛŒÚ©! Ù‡Ø¯Ù Ø§Ù…Ø±ÙˆØ² ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯'); confettiSafe(); const gw = document.getElementById('miniWater'); if(gw) gw.classList.add('water-goal-achieved'); setTimeout(()=>gw && gw.classList.remove('water-goal-achieved'),1400); }
    else notify('Ø¢Ø¨','ÛŒÚ© Ù„ÛŒÙˆØ§Ù† Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
    save();
  },
  remove(){
    const d = todayStr();
    state.water.history[d] = Math.max(0,(state.water.history[d]||0)-1);
    save(); showToast('ÛŒÚ© Ù„ÛŒÙˆØ§Ù† Ø­Ø°Ù Ø´Ø¯');
  },
  renderMini(){
    const container = document.getElementById('miniWater'); container.innerHTML='';
    const cur = state.water.history[todayStr()]||0;
    for(let i=0;i<state.water.goal;i++){
      const el = document.createElement('div'); el.className='water-cup' + (i<cur ? ' full':''); el.innerHTML = '<i class="fas fa-tint"></i>';
      el.onclick = ()=> { if(i>=cur) Water.add(); else Water.remove(); };
      container.appendChild(el);
    }
    document.getElementById('miniWaterCount').innerText = `${cur} / ${state.water.goal}`;
    document.getElementById('waterGoal').innerText = state.water.goal;
  }
};

/* ========== JOURNAL ========== */
const Journal = {
  addFromUI(){
    const title = document.getElementById('journalTitle').value.trim();
    const text = document.getElementById('journalText').value.trim();
    const mood = document.getElementById('journalMood') ? document.getElementById('journalMood').value : '';
    const trigger = document.getElementById('journalTrigger').value.trim();
    if(!text) return showToast('Ù…ØªÙ† Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³');
    const now = new Date();
    state.journal.unshift({id:uid(),title,text,mood,trigger,date:now.toLocaleDateString('fa-IR'),time:now.toLocaleTimeString('fa-IR',{hour:'2-digit',minute:'2-digit'})});
    addXP(30); notify('Ø¯ÙØªØ±Ú†Ù‡','Ø®Ø§Ø·Ø±Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
    document.getElementById('journalTitle').value=''; document.getElementById('journalText').value=''; document.getElementById('journalTrigger').value='';
    save();
  },
  render(){
    const list = document.getElementById('journalList'); list.innerHTML='';
    state.journal.slice(0,50).forEach(j=>{
      const el = document.createElement('div'); el.className='journal-entry';
      el.innerHTML = `<div style="font-weight:700">${j.title||'(Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†)'}</div><div class="small-muted">${j.date} â€¢ ${j.time} â€¢ ${j.mood}</div><p style="margin-top:8px">${j.text}</p>`;
      list.appendChild(el);
    });
  },
  export(){ const data="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(state.journal)); const a=document.createElement('a'); a.href=data; a.download=`journal_${Date.now()}.json`; a.click(); }
};

/* ========== WALLET ========== */
const Wallet = {
  addFromUI(type){
    const amt = parseInt(document.getElementById('txAmount').value||0);
    const desc = document.getElementById('txDesc').value|| (type==='income'?'Ø¯Ø±Ø¢Ù…Ø¯':'Ù‡Ø²ÛŒÙ†Ù‡');
    if(!amt) return showToast('Ù…Ø¨Ù„Øº Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†');
    this.execute(type==='income'?amt:-amt, desc);
    document.getElementById('txAmount').value=''; document.getElementById('txDesc').value='';
  },
  execute(val,desc){
    state.wallet.balance = (state.wallet.balance||0) + val;
    state.wallet.transactions.unshift({id:uid(),val,desc,date:new Date().toLocaleDateString('fa-IR')});
    addXP(10); notify('ØªØ±Ø§Ú©Ù†Ø´', `${desc}: ${val>0?'+':''}${val}`); save();
  },
  render(){
    document.getElementById('walletBalance').innerText = (state.wallet.balance||0).toLocaleString();
    const txList = document.getElementById('txList'); txList.innerHTML='';
    state.wallet.transactions.slice(0,40).forEach(t=>{
      const el = document.createElement('div'); el.className='tx-row';
      el.innerHTML = `<div><div style="font-weight:700">${t.desc}</div><div class="small-muted">${t.date}</div></div><div style="font-weight:800;color:${t.val>0? '#00b894':'#ff6b6b'}">${t.val>0?'+':''}${t.val.toLocaleString()}</div>`;
      txList.appendChild(el);
    });
  }
};

/* ========== XP ========== */
function addXP(n){
  state.xp.xp += n;
  const need = state.xp.level * 100;
  if(state.xp.xp >= need){
    state.xp.level++; state.xp.xp -= need;
    Swal.fire({title:'LEVEL UP! ğŸ†™', text:`ØªØ¨Ø±ÛŒÚ©! Ù„ÙˆÙ„ ${state.xp.level} Ø´Ø¯ÛŒ!`, icon:'success'});
    confettiSafe();
  }
  addToWeek('xpWeek', new Date(), n);
}

/* ========== Analytics charts ========== */
let xpChart=null, waterChart=null;
function renderAnalytics(){
  try{
    const xpCtx = document.getElementById('xpChart').getContext('2d');
    if(xpChart) xpChart.destroy();
    xpChart = new Chart(xpCtx,{type:'line',data:{labels:['Ø´','ÛŒ','Ø¯','Ø³','Ú†','Ù¾','Ø¬'],datasets:[{data:state.stats.xpWeek,borderColor:state.settings.theme==='light' ? '#ff6fa8' : '#ff7eb3',backgroundColor:'rgba(255,126,179,0.12)',fill:true}]},options:{plugins:{legend:{display:false}},scales:{y:{display:false},x:{display:false}}}});
    const wCtx = document.getElementById('waterChart').getContext('2d');
    if(waterChart) waterChart.destroy();
    waterChart = new Chart(wCtx,{type:'bar',data:{labels:['Ø´','ÛŒ','Ø¯','Ø³','Ú†','Ù¾','Ø¬'],datasets:[{data:state.stats.waterWeek,backgroundColor:'#36a2ff'}]},options:{plugins:{legend:{display:false}},scales:{y:{display:false},x:{display:false}}}});
  }catch(e){ console.warn('chart err', e) }
}

/* ========== End-of-day summary ========== */
function runEndOfDay(){
  const completed = state.todos.filter(t=>t.done).length;
  const water = state.water.history[todayStr()]||0;
  const journalCount = state.journal.filter(j=>j.date===todayStr()).length;
  const xpGained = state.stats.xpWeek.reduce((a,b)=>a+b,0);
  const msg = `Ø®Ù„Ø§ØµÙ‡ Ø§Ù…Ø±ÙˆØ²:\n- Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡: ${completed}\n- Ø¢Ø¨
  Ù…ØµØ±ÙÛŒ: ${water} Ù„ÛŒÙˆØ§Ù†
- ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø«Ø¨Øª Ø´Ø¯Ù‡: ${journalCount}
- Ø§Ù…ØªÛŒØ§Ø² Ú©Ø³Ø¨ Ø´Ø¯Ù‡ (Ù‡ÙØªÙ‡): ${xpGained}`;
  
  Swal.fire({
    title: 'Ø®Ù„Ø§ØµÙ‡ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø§Ù…Ø±ÙˆØ² Ø´Ù…Ø§ âœ¨',
    text: msg,
    icon: 'info',
    confirmButtonText: 'Ø¹Ø§Ù„ÛŒÙ‡!'
  });
}

/* ========== NAVIGATION SYSTEM ========== */
function switchView(viewId, btn) {
  // Ø§Ú¯Ø± Ø±ÙˆÛŒ Ø¢ÛŒÚ©ÙˆÙ† Ø¢Ø¨ (FAB) Ú©Ù„ÛŒÚ© Ø´Ø¯ØŒ Ø¨Ø±Ùˆ Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ùˆ Ø§Ø³Ú©Ø±ÙˆÙ„ Ú©Ù† Ø±ÙˆÛŒ Ø¨Ø®Ø´ Ø¢Ø¨
  if (viewId === 'water') {
    switchView('dashboard', document.getElementById('nav-dashboard'));
    setTimeout(() => {
      document.getElementById('miniWater').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 300);
    return;
  }

  // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… Ø¨Ø®Ø´â€ŒÙ‡Ø§
  const sections = ['dashboard', 'todos', 'journal', 'wallet', 'analytics'];
  sections.forEach(s => {
    const el = document.getElementById('view-' + s);
    if (el) el.classList.add('hidden');
  });

  // Ù†Ù…Ø§ÛŒØ´ Ø¨Ø®Ø´ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
  const target = document.getElementById('view-' + viewId);
  if (target) target.classList.remove('hidden');

  // Ø¢Ù¾Ø¯ÛŒØª ÙˆØ¶Ø¹ÛŒØª Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ø§ÙˆØ¨Ø±ÛŒ
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');

  // Ø±Ù†Ø¯Ø± Ú©Ø±Ø¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø®ØµÙˆØµ Ù‡Ø± Ø¨Ø®Ø´
  if (viewId === 'dashboard') renderDashboard();
  if (viewId === 'todos') Todos.render();
  if (viewId === 'journal') Journal.render();
  if (viewId === 'wallet') Wallet.render();
  if (viewId === 'analytics') renderAnalytics();
}

/* ========== SETTINGS ========== */
function openSettings() {
  Swal.fire({
    title: 'ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾Ø±ÙˆÙØ§ÛŒÙ„',
    html: `
      <div style="direction:rtl; text-align:right">
        <label class="small-muted">Ù†Ø§Ù… Ø´Ù…Ø§:</label>
        <input id="set-name" class="swal2-input" value="${state.profile.name}" placeholder="Ù†Ø§Ù… Ø´Ù…Ø§">
        <label class="small-muted">Ù‡Ø¯Ù Ø±ÙˆØ²Ø§Ù†Ù‡ Ø¢Ø¨ (Ù„ÛŒÙˆØ§Ù†):</label>
        <input id="set-water" type="number" class="swal2-input" value="${state.water.goal}">
        <label class="small-muted">ØªÙ… Ø¨Ø±Ù†Ø§Ù…Ù‡:</label>
        <select id="set-theme" class="swal2-select" style="width:100%">
          <option value="dark" ${state.settings.theme === 'dark' ? 'selected' : ''}>ØªØ§Ø±ÛŒÚ© (Deep Space)</option>
          <option value="light" ${state.settings.theme === 'light' ? 'selected' : ''}>Ø±ÙˆØ´Ù† (Soft Light)</option>
        </select>
      </div>
    `,
    showCancelButton: true,
    confirmButtonText: 'Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª',
    cancelButtonText: 'Ù„ØºÙˆ',
    preConfirm: () => {
      return {
        name: document.getElementById('set-name').value,
        water: parseInt(document.getElementById('set-water').value),
        theme: document.getElementById('set-theme').value
      }
    }
  }).then((result) => {
    if (result.isConfirmed) {
      state.profile.name = result.value.name;
      state.water.goal = result.value.water || 8;
      applyTheme(result.value.theme);
      save();
      showToast('ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´Ø¯');
    }
  });
}

/* ========== CORE RENDER ========== */
function renderAll() {
  // Ø¢Ù¾Ø¯ÛŒØª Ù‡Ø¯Ø±
  document.getElementById('profileName').innerText = state.profile.name;
  document.getElementById('profileAvatar').src = state.profile.avatar;
  
  // Ø±Ù†Ø¯Ø± Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
  renderDashboard();
  Water.renderMini();
  Todos.render();
  Journal.render();
  Wallet.render();
  
  // Ø§Ú¯Ø± Ø¯Ø± Ù†Ù…Ø§ÛŒ Ø¢Ù†Ø§Ù„ÛŒØ² Ù‡Ø³ØªÛŒÙ…
  if (!document.getElementById('view-analytics').classList.contains('hidden')) {
    renderAnalytics();
  }
}

/* ========== INITIALIZATION ========== */
// Ú†Ø±Ø®Ø´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø§Ù†Ú¯ÛŒØ²Ø´ÛŒ Ù‡Ø± 10 Ø«Ø§Ù†ÛŒÙ‡
setInterval(rotateMotiv, 10000);

// Ø§Ø¬Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ù‡Ù†Ú¯Ø§Ù… Ù„ÙˆØ¯ Ø´Ø¯Ù† ØµÙØ­Ù‡
window.onload = () => {
  renderAll();
  
  // Ø§ÙÚ©Øª ÙˆØ±ÙˆØ¯ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ø§Ù…
  const nameEl = document.getElementById('profileName');
  nameEl.style.opacity = '0';
  setTimeout(() => {
    nameEl.style.transition = 'opacity 1s ease';
    nameEl.style.opacity = '1';
  }, 500);

  console.log("QueenX Mobile Core Ready.");
};
</script>
</body>
</html>